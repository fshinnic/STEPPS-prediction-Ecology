cex = 0.2)
plot(st_geometry(us.shp), add = TRUE, border = "black", lwd = 0.5)
y_veg = convert_counts(counts, tree_type, taxa_sub)
y_veg
convert_counts
taxa = colnames(y_veg)
taxa
y_veg = as.matrix(round(unname(y_veg)))
y_veg
rownames(y_veg) = NULL
y_veg = unname(y_veg)
K = as.integer(ncol(y_veg))
W = K-1
N_pls = nrow(y_veg)
# FIXME: ADD STATE TO GRID
# coarse_domain  = coarse_domain[coarse_domain$state %in% states_pls,]
coarse_centers = domain[,1:2]
coarse_centers
domain
states_pls <- c(
"wisconsin",
"michigan:south",
"michigan:north",
"minnesota"
)
states_pls <- c(
"wisconsin",
"michigan:north",
"minnesota"
)
domain <- meta[meta$state2 %in% states_pls, c("x", "y")]
domain
domain <- meta[meta$state2 %in% states_pls, c("x", "y")]
# FS - created domain of uppermidwest form PLS grid centers
states_pls <- c("wisconsin", "michigan:north","minnesota")
domain <- meta[meta$state2 %in% states_pls, c("x", "y")]
# FIXME: ADD STATE TO GRID
# coarse_domain  = coarse_domain[coarse_domain$state %in% states_pls,]
coarse_centers = domain[,1:2]
coarse_centers
domain
plot(coarse_centers[,1]*rescale, coarse_centers[,2]*rescale, col='blue')
plot(us.shp, add=TRUE)
coarse_centers = domain[,1:2]
plot(coarse_centers[,1]*rescale, coarse_centers[,2]*rescale, col='blue')
plot(us.shp, add=TRUE)
plot(coarse_centers[,1] * rescale,
coarse_centers[,2] * rescale,
col = "blue",
pch = 19,
cex = 0.3,
asp = 1,
axes = FALSE,
xlab = "",
ylab = "")
plot(st_geometry(us.shp), add = TRUE, border = "black")
plot(st_geometry(us.shp), add = TRUE, border = "black")
plot(coarse_centers[,1] * rescale,
coarse_centers[,2] * rescale,
col = "blue",
pch = 19,
cex = 0.3,
asp = 1,
axes = FALSE,
xlab = "",
ylab = "")
plot(st_geometry(us.shp), add = TRUE, border = "black")
pts <- st_as_sf(domain, coords = c("x","y"), crs = 3175)
pts
mi_poly <- us.shp[us.shp$NAME == "Michigan", ]
mi_poly <- st_transform(mi_poly, 3175)
mi_poly
inside_mi <- st_within(pts, mi_poly, sparse = FALSE)[,1]
mi_poly <- st_transform(mi_poly, 3175)
inside_mi <- st_within(pts, mi_poly, sparse = FALSE)[,1]
table(inside_mi)
inside_mi <- st_within(pts, mi_poly, sparse = FALSE)[,1]
# Suppose you already have us.shp loaded as us.shp
states_of_interest <- us.shp %>%
filter(NAME %in% c("Wisconsin", "Minnesota", "Michigan"))
# 1. Make your points an sf object
pts <- st_as_sf(domain, coords = c("x", "y"), crs = 3175)  # use your original projection
# 2. Make an sf object of the states of interest
# Suppose you already have us.shp loaded as us.shp
states_of_interest <- us.shp %>%
filter(NAME %in% c("Wisconsin", "Minnesota", "Michigan"))
# FS - created domain of uppermidwest form PLS grid centers
states_pls <- c("wisconsin", "michigan:north","minnesota")
domain <- meta[meta$state2 %in% states_pls, c("x", "y")]
# FIXME: ADD STATE TO GRID
# coarse_domain  = coarse_domain[coarse_domain$state %in% states_pls,]
coarse_centers = domain[,1:2]
# check domain working with
plot(coarse_centers[,1] * rescale,
coarse_centers[,2] * rescale,
col = "blue",
pch = 19,
cex = 0.3,
asp = 1,
axes = FALSE,
xlab = "",
ylab = "")
plot(st_geometry(us.shp), add = TRUE, border = "black")
# check domain working with
plot(coarse_centers[,1] * rescale,
coarse_centers[,2] * rescale,
col = "blue",
pch = 19,
cex = 0.3,
asp = 1,
axes = FALSE,
xlab = "",
ylab = "")
plot(st_geometry(us.shp), add = TRUE, border = "black")
# FS - Corrected for SP object; checks that seperated out the correct uppermidwest cells
# plot(centers_pls[,1]*rescale, centers_pls[,2]*rescale, asp=1, axes=F,  col='antiquewhite4', xlab='',ylab='', pch=19, cex=0.2) # old code
# plot(us.shp, add=T) # old code
# plots center of pls grid cells (8 km x 8 km)
plot(centers_pls[,1] * rescale,
centers_pls[,2] * rescale,
asp = 1,
axes = FALSE,
col = "antiquewhite4",
pch = 19,
cex = 0.2)
# adds borders
plot(st_geometry(us.shp), add = TRUE, border = "black", lwd = 0.5)
# FS - Corrected for SP object; checks that seperated out the correct uppermidwest cells
# plot(centers_pls[,1]*rescale, centers_pls[,2]*rescale, asp=1, axes=F,  col='antiquewhite4', xlab='',ylab='', pch=19, cex=0.2) # old code
# plot(us.shp, add=T) # old code
# plots center of pls grid cells (8 km x 8 km)
plot(centers_pls[,1] * rescale,
centers_pls[,2] * rescale,
asp = 1,
axes = FALSE,
col = "antiquewhite4",
pch = 19,
cex = 0.2)
split_mi
# FS - geographical location of each count
meta   = pls.raw[,1:(taxa.start.col-1)]
# FS - use the new function
# create collumns state (minnesota, south dakatoa, north dakota, iowa, na, wiconsin, michigan:north, illinois, michigan:south, indiana, ohio)
# and state2 (minnesota, wisconsin, michigan:north, and michigan:south) the corrected map look up
meta        = split_mi(meta)
# changes taxa names to lower case
colnames(pls.raw) = tolower(colnames(pls.raw))
# pull the subset of proportions
taxa.start.col = min(match(tolower(rownames(convert)), colnames(pls.raw)), na.rm=TRUE)
# FS - raw pollen couts for each taxa
counts = pls.raw[,taxa.start.col:ncol(pls.raw)]
# FS - geographical location of each count
meta   = pls.raw[,1:(taxa.start.col-1)]
# FS - use the new function
# create collumns state (minnesota, south dakatoa, north dakota, iowa, na, wiconsin, michigan:north, illinois, michigan:south, indiana, ohio)
# and state2 (minnesota, wisconsin, michigan:north, and michigan:south) the corrected map look up
meta        = split_mi(meta)
# read in veg data and output
# veg data specifies which knots to use
load(path_veg_data)
veg_post = readRDS(file=path_veg_pars)
# changes taxa names to lower case
colnames(pls.raw) = tolower(colnames(pls.raw))
# pull the subset of proportions
taxa.start.col = min(match(tolower(rownames(convert)), colnames(pls.raw)), na.rm=TRUE)
# FS - raw pollen couts for each taxa
counts = pls.raw[,taxa.start.col:ncol(pls.raw)]
# FS - geographical location of each count
meta   = pls.raw[,1:(taxa.start.col-1)]
# FS - use the new function
# create collumns state (minnesota, south dakatoa, north dakota, iowa, na, wiconsin, michigan:north, illinois, michigan:south, indiana, ohio)
# and state2 (minnesota, wisconsin, michigan:north, and michigan:south) the corrected map look up
meta        = split_mi(meta)
split_mi
# only keep counts/meta that are in the corrected "minnesota" "wisconsin" "michigan:north" (states_pls)
counts      = counts[which(meta$state2 %in% states_pls),]
meta        = meta[which(meta$state2 %in% states_pls),]
centers_pls = data.frame(x=meta$x, y=meta$y)/rescale # megameters!
# FS - Corrected for SP object; checks that seperated out the correct uppermidwest cells
# plot(centers_pls[,1]*rescale, centers_pls[,2]*rescale, asp=1, axes=F,  col='antiquewhite4', xlab='',ylab='', pch=19, cex=0.2) # old code
# plot(us.shp, add=T) # old code
# plots center of pls grid cells (8 km x 8 km)
plot(centers_pls[,1] * rescale,
centers_pls[,2] * rescale,
asp = 1,
axes = FALSE,
col = "antiquewhite4",
pch = 19,
cex = 0.2)
# adds borders
plot(st_geometry(us.shp), add = TRUE, border = "black", lwd = 0.5)
split_mi
# FS - Corrected for SP object; checks that seperated out the correct uppermidwest cells
# plot(centers_pls[,1]*rescale, centers_pls[,2]*rescale, asp=1, axes=F,  col='antiquewhite4', xlab='',ylab='', pch=19, cex=0.2) # old code
# plot(us.shp, add=T) # old code
# plots center of pls grid cells (8 km x 8 km)
plot(centers_pls[,1] * rescale,
centers_pls[,2] * rescale,
asp = 1,
axes = FALSE,
col = "antiquewhite4",
pch = 19,
cex = 0.2)
# FS - Corrected for SP object; checks that seperated out the correct uppermidwest cells
# plot(centers_pls[,1]*rescale, centers_pls[,2]*rescale, asp=1, axes=F,  col='antiquewhite4', xlab='',ylab='', pch=19, cex=0.2) # old code
# plot(us.shp, add=T) # old code
# plots center of pls grid cells (8 km x 8 km)
plot(centers_pls[,1] * rescale,
centers_pls[,2] * rescale,
asp = 1,
axes = FALSE,
col = "antiquewhite4",
pch = 19,
cex = 0.2)
# adds borders
plot(st_geometry(us.shp), add = TRUE, border = "black", lwd = 0.5)
# FS - aggreg raw pollen count data into 12 taxa (including OTHER group)
y_veg = convert_counts(counts, tree_type, taxa_sub)
# FS - removes collumn names, creating counts as ordered matrix
taxa = colnames(y_veg)
y_veg = as.matrix(round(unname(y_veg)))
rownames(y_veg) = NULL
y_veg = unname(y_veg)
K = as.integer(ncol(y_veg))
W = K-1
N_pls = nrow(y_veg)
# FS - created domain of uppermidwest form PLS grid centers
states_pls <- c("wisconsin", "michigan:north","minnesota")
domain <- meta[meta$state2 %in% states_pls, c("x", "y")]
# FIXME: ADD STATE TO GRID
# coarse_domain  = coarse_domain[coarse_domain$state %in% states_pls,]
coarse_centers = domain[,1:2]
# check domain working with
plot(coarse_centers[,1] * rescale,
coarse_centers[,2] * rescale,
col = "blue",
pch = 19,
cex = 0.3,
asp = 1,
axes = FALSE,
xlab = "",
ylab = "")
plot(st_geometry(us.shp), add = TRUE, border = "black")
plot(st_geometry(us.shp), add = TRUE, border = "black", lwd = 0.5)
# assign grid to centers_veg
centers_veg = coarse_centers
N = nrow(centers_veg)
# subdomain boundaries
xlo = min(centers_veg$lat)
xhi = max(centers_veg$lat)
# subdomain boundaries
xlo = min(centers_veg$x)
xhi = max(centers_veg$x)
ylo = min(centers_veg$y)
yhi = max(centers_veg$y)
# set tamarack to 0 at tamarack creek; see Dawson et al. QSR 2016
pollen_ts[pollen_ts$id == 2624, 'TAMARACK'] = rep(0, sum(pollen_ts$id == 2624))
saveRDS(pollen_ts, file='data/pollen_ts.RDS')
pollen_ts1 = pollen_ts[which(pollen_ts$state %in% states_pol),]
pollen_ts1
states_pol
colnames(pollen_ts1)
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_to_albers
pollen_to_albers <- function(pollen_ts) {
library(sp)
# Create spatial points
centers_pol <- data.frame(x = pollen_ts$long, y = pollen_ts$lat)
coordinates(centers_pol) <- ~ x + y
proj4string(centers_pol) <- CRS('+proj=longlat +ellps=WGS84')
# Transform to Albers
centers_polA <- spTransform(centers_pol, CRS('+init=epsg:3175'))
# Convert to data frame & scale
centers_polA <- as.data.frame(centers_polA) / 1000000
colnames(centers_polA) <- c("x", "y")
# Update original data
pollen_ts$long <- centers_polA$x
pollen_ts$lat  <- centers_polA$y
# Rename columns
colnames(pollen_ts)[grep("lat", colnames(pollen_ts))]  <- 'y'
colnames(pollen_ts)[grep("long", colnames(pollen_ts))] <- 'x'
return(pollen_ts)
}
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_ts2
pollen_locs = cbind(pollen_ts2$x, pollen_ts2$y)
pollen_int  = cores_near_domain(pollen_locs, centers_veg, cell_width = res*8000/rescale)
pollen_int
pollen_locs
pollen_int  = cores_near_domain(pollen_locs, centers_veg, cell_width = res*8000/rescale)
pollen_int
pollen_locs
centers_veg
cores_near_domain
head(pollen_locs)
head(centers_veg)
pollen_locs
head(pollen_locs)
head(centers_veg)
cores_near_domain
pollen_locs
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_ts2
# FS - location of pollen
pollen_locs = cbind(pollen_ts2$x, pollen_ts2$y)
pollen_locs
pollen_ts1
pollen_ts1$x
pollen_to_albers <- function(pollen_ts) {
library(sp)
# Create spatial points
centers_pol <- data.frame(x = pollen_ts$long, y = pollen_ts$lat)
coordinates(centers_pol) <- ~ x + y
proj4string(centers_pol) <- CRS('+proj=longlat +ellps=WGS84')
# Transform to Albers
centers_polA <- spTransform(centers_pol, CRS('+init=epsg:3175'))
# Convert to data frame & scale
centers_polA <- as.data.frame(centers_polA) / 1000000
colnames(centers_polA) <- c("x", "y")
# Update original data
pollen_ts$long <- centers_polA$x
pollen_ts$lat  <- centers_polA$y
# # Rename columns
# colnames(pollen_ts)[grep("lat", colnames(pollen_ts))]  <- 'y'
# colnames(pollen_ts)[grep("long", colnames(pollen_ts))] <- 'x'
return(pollen_ts)
}
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
# FS - location of pollen
pollen_locs = cbind(pollen_ts2$x, pollen_ts2$y)
# FS - FIX ME - currently no matches ie no cores in the domain
pollen_int  = cores_near_domain(pollen_locs, centers_veg, cell_width = res*8000/rescale)
pollen_locs
# FS - location of pollen
pollen_locs = cbind(pollen_ts2$x, pollen_ts2$y)
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_ts2
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_to_albers <- function(pollen_ts) {
library(sp)
# Create spatial points
centers_pol <- data.frame(x = pollen_ts$long, y = pollen_ts$lat)
coordinates(centers_pol) <- ~ x + y
proj4string(centers_pol) <- CRS('+proj=longlat +ellps=WGS84')
# Transform to Albers
centers_polA <- spTransform(centers_pol, CRS('+init=epsg:3175'))
# Convert to data frame & scale
centers_polA <- as.data.frame(centers_polA) / 1000000
colnames(centers_polA) <- c("x", "y")
# Update original data
pollen_ts$x <- centers_polA$x
pollen_ts$y  <- centers_polA$y
# # Rename columns
# colnames(pollen_ts)[grep("lat", colnames(pollen_ts))]  <- 'y'
# colnames(pollen_ts)[grep("long", colnames(pollen_ts))] <- 'x'
return(pollen_ts)
}
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
# FS - location of pollen
pollen_locs = cbind(pollen_ts2$x, pollen_ts2$y)
# FS - FIX ME - currently no matches ie no cores in the domain
pollen_int  = cores_near_domain(pollen_locs, centers_veg, cell_width = res*8000/rescale)
pollen_int
pollen_locs
centers_veg
# Convert to data frame & scale
#  centers_polA <- as.data.frame(centers_polA) / 1000000
colnames(centers_polA) <- c("x", "y")
pollen_to_albers <- function(pollen_ts) {
library(sp)
# Create spatial points
centers_pol <- data.frame(x = pollen_ts$long, y = pollen_ts$lat)
coordinates(centers_pol) <- ~ x + y
proj4string(centers_pol) <- CRS('+proj=longlat +ellps=WGS84')
# Transform to Albers
centers_polA <- spTransform(centers_pol, CRS('+init=epsg:3175'))
# Convert to data frame & scale
#  centers_polA <- as.data.frame(centers_polA) / 1000000
colnames(centers_polA) <- c("x", "y")
# Update original data
pollen_ts$x <- centers_polA$x
pollen_ts$y  <- centers_polA$y
# # Rename columns
# colnames(pollen_ts)[grep("lat", colnames(pollen_ts))]  <- 'y'
# colnames(pollen_ts)[grep("long", colnames(pollen_ts))] <- 'x'
return(pollen_ts)
}
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_to_albers <- function(pollen_ts) {
library(sp)
# Create spatial points
centers_pol <- data.frame(x = pollen_ts$long, y = pollen_ts$lat)
coordinates(centers_pol) <- ~ x + y
proj4string(centers_pol) <- CRS('+proj=longlat +ellps=WGS84')
# Transform to Albers
centers_polA <- spTransform(centers_pol, CRS('+init=epsg:3175'))
# Convert to data frame & scale
centers_polA <- as.data.frame(centers_polA)
colnames(centers_polA) <- c("x", "y")
# Update original data
pollen_ts$x <- centers_polA$x
pollen_ts$y  <- centers_polA$y
# # Rename columns
# colnames(pollen_ts)[grep("lat", colnames(pollen_ts))]  <- 'y'
# colnames(pollen_ts)[grep("long", colnames(pollen_ts))] <- 'x'
return(pollen_ts)
}
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_ts
pollen_to_albers <- function(pollen_ts) {
# Load required library
library(sp)
# 1. Create spatial points from latitude and longitude
centers_pol <- data.frame(x = pollen_ts$long, y = pollen_ts$lat)
coordinates(centers_pol) <- ~ x + y
proj4string(centers_pol) <- CRS("+proj=longlat +datum=WGS84 +no_defs")
# 2. Transform to Albers Equal Area (EPSG:3175 - NAD83 / Conus Albers)
centers_polA <- spTransform(centers_pol, CRS(SRS_string = "EPSG:3175"))
# 3. Convert back to a data frame with x and y
centers_polA_df <- as.data.frame(centers_polA)
colnames(centers_polA_df) <- c("x", "y")
# 4. Add Albers coordinates to original data
pollen_ts$x <- centers_polA_df$x
pollen_ts$y <- centers_polA_df$y
return(pollen_ts)
}
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_ts2
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_ts1
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
str(pollen_ts1)
head(pollen_ts1)
pollen_to_albers <- function(pollen_ts) {
library(sp)
# Remove rows with missing coordinates
pollen_ts <- pollen_ts[!is.na(pollen_ts$lat) & !is.na(pollen_ts$long), ]
if(nrow(pollen_ts) == 0) stop("No valid coordinates to transform.")
centers_pol <- data.frame(x = pollen_ts$long, y = pollen_ts$lat)
coordinates(centers_pol) <- ~ x + y
proj4string(centers_pol) <- CRS("+proj=longlat +datum=WGS84 +no_defs")
centers_polA <- spTransform(centers_pol, CRS(SRS_string = "EPSG:3175"))
centers_polA_df <- as.data.frame(centers_polA)
colnames(centers_polA_df) <- c("x", "y")
pollen_ts$x <- centers_polA_df$x
pollen_ts$y <- centers_polA_df$y
return(pollen_ts)
}
# FS - had to edit this function to use sf instead
# reproject pollen coords from lat long to Albers
pollen_ts2 = pollen_to_albers(pollen_ts1)
pollen_ts2
# FS - location of pollen
pollen_locs = cbind(pollen_ts2$x, pollen_ts2$y)
# FS - FIX ME - currently no matches ie no cores in the domain
pollen_int  = cores_near_domain(pollen_locs, centers_veg, cell_width = res*8000/rescale)
pollen_int
pollen_locs
head()
head(pollen_locs)
head(centers_veg)
# FS - FIX ME - currently no matches ie no cores in the domain
pollen_int  = cores_near_domain(pollen_locs, centers_veg, cell_width = res*8000/rescale)
pollen_int
plot(centers_veg$x, centers_veg$y, col='green', pch=19, main='Vegetation vs Pollen')
points(pollen_locs[,1], pollen_locs[,2], col='red', pch=19)
cell_width_value <- res*8000/rescale
print(cell_width_value)
cell_width_value <- 8000   # or slightly larger
pollen_int <- cores_near_domain(pollen_locs, centers_veg, cell_width = cell_width_value)
pollen_int
idx_pollen_int = apply(pollen_locs, 1,
function(x) if (any(rdist(x, pollen_int) < 1e-8)) {return(TRUE)} else {return(FALSE)})
idx_pollen_int
pollen_ts3 = pollen_ts2[idx_pollen_int, ]
pollen_ts3
# plot domain and core locations
par(mfrow=c(1,1))
plot(centers_veg$lat*rescale, centers_veg$long*rescale)
points(pollen_ts3$lat*rescale, pollen_ts3$long*rescale, col='blue', pch=19)
plot(us.shp, add=T, lwd=2)
centers_veg
plot(centers_veg$x*rescale, centers_veg$y*rescale)
points(pollen_ts3$lat*rescale, pollen_ts3$long*rescale, col='blue', pch=19)
points(pollen_ts3$x*rescale, pollen_ts3$y*rescale, col='blue', pch=19)
plot(us.shp, add=T, lwd=2)
